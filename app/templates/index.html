<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📊 Detection Analysis</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #0b0b0b, #1a1a2e);
            color: #fff;
            font-family: 'Segoe UI', Arial, sans-serif;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 {
            text-align: center;
            color: #e63946;
            margin-bottom: 30px;
            font-size: 28px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .tab-btn {
            background: rgba(230, 57, 70, 0.2);
            color: #fff;
            border: 2px solid #e63946;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            background: #e63946;
            box-shadow: 0 4px 15px rgba(230, 57, 70, 0.4);
        }
        .tab-btn:hover { transform: translateY(-2px); }
        .tab-content {
            display: none;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        .tab-content.active { display: block; }
        .upload-section {
            background: rgba(0,0,0,0.3);
            border: 2px dashed #e63946;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-section:hover {
            background: rgba(230, 57, 70, 0.1);
            border-color: #ff6b7a;
        }
        .upload-section input { display: none; }
        .upload-label {
            cursor: pointer;
            font-size: 18px;
            color: #aaa;
        }
        .upload-section.dragging {
            background: rgba(230, 57, 70, 0.2);
            border-color: #ff6b7a;
        }
        .file-info {
            margin-top: 10px;
            font-size: 14px;
            color: #4caf50;
        }
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        button {
            background: linear-gradient(135deg, #e63946, #d62828);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(230, 57, 70, 0.3);
        }
        button:hover {
            background: linear-gradient(135deg, #d62828, #a71228);
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        @media (max-width: 768px) {
            .results { grid-template-columns: 1fr; }
        }
        .result-box {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #e63946;
        }
        .result-box h3 {
            color: #e63946;
            margin-bottom: 15px;
        }
        .result-image {
            width: 100%;
            max-height: 500px;
            border-radius: 8px;
            object-fit: contain;
            margin-bottom: 10px;
        }
        .result-info {
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.6;
            color: #4caf50;
        }
        .result-info h4 {
            color: #e63946;
            margin-bottom: 10px;
            margin-top: 10px;
        }
        .result-info h4:first-child { margin-top: 0; }
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        .spinner {
            border: 4px solid rgba(230, 57, 70, 0.2);
            border-top: 4px solid #e63946;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .error {
            background: rgba(255, 100, 100, 0.2);
            border-left: 4px solid #ff6b7a;
            color: #ff9999;
        }
        .success {
            background: rgba(76, 175, 80, 0.2);
            border-left: 4px solid #4caf50;
            color: #90ee90;
        }
        .download-btn {
            background: #4caf50;
            margin-top: 10px;
        }
        .download-btn:hover { background: #45a049; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(76, 175, 80, 0.1);
            border-left: 4px solid #4caf50;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4caf50;
        }
        .stat-label {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
        }
        .btn-orange {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }
        .btn-orange:hover {
            background: linear-gradient(135deg, #f57c00, #e65100);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📊 Faster R-CNN Detection Analysis</h1>
        
        <div class="tabs">
            <button class="tab-btn active" data-tab="image">📷 Image Analysis</button>
            <button class="tab-btn" data-tab="video">🎬 Video Analysis</button>
        </div>

        <!-- IMAGE TAB -->
        <div id="image" class="tab-content active">
            <div class="upload-section" data-upload="image">
                <input type="file" id="imageInput" accept="image/*">
                <label for="imageInput" class="upload-label">
                    Click to upload or drag & drop<br>
                    <span style="font-size: 12px; color: #666;">Supported: JPG, PNG, GIF, WebP</span>
                </label>
                <div class="file-info" id="imageFileName"></div>
            </div>

            <div class="camera-container" style="text-align:center; margin-bottom:20px;">
                <div id="videoWrapper" style="position:relative; display:inline-block; max-width:500px; width:100%;">
                    <video id="camera" autoplay playsinline muted style="width:100%; height:auto; border-radius:10px; display:none;"></video>
                    <canvas id="guideCanvas" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; display:none;"></canvas>
                </div>
                <div id="capturePreview" style="display:none; margin-top:15px;">
                    <img id="capturedImage" style="max-width:500px; width:100%; border-radius:10px; border:3px solid #4caf50;" alt="Captured">
                    <p style="color:#4caf50; margin-top:10px; font-weight:600;">✅ Image captured successfully!</p>
                </div>
                <div style="margin-top:10px;">
                    <button id="toggleCameraBtn">📸 Capture from Camera</button>
                    <button id="captureBtn" style="display:none;">🟢 Take Picture</button>
                    <button id="retakeBtn" class="btn-orange" style="display:none;">🔄 Retake</button>
                </div>
            </div>

            <div class="controls">
                <button id="analyzeImageBtn" disabled>Analyze Image</button>
                <button id="clearImageBtn">Clear</button>
            </div>

            <div class="loading" id="imageLoading">
                <div class="spinner"></div>
                <p>Analyzing image...</p>
            </div>

            <div class="results" id="imageResults" style="display: none;">
                <div class="result-box">
                    <h3>Original Image</h3>
                    <img id="originalImage" class="result-image" alt="Original">
                </div>
                <div class="result-box">
                    <h3>Detections Info</h3>
                    <div class="stats" id="imageStats"></div>
                    <div class="result-info" id="imageInfo"></div>
                </div>
                <div class="result-box">
                    <h3>Detected Objects</h3>
                    <img id="visualizedImage" class="result-image" alt="Visualized">
                </div>
            </div>

            <div id="imageError"></div>
        </div>

        <!-- VIDEO TAB -->
        <div id="video" class="tab-content">
            <div class="upload-section" data-upload="video">
                <input type="file" id="videoInput" accept="video/*">
                <label for="videoInput" class="upload-label">
                    Click to upload or drag & drop<br>
                    <span style="font-size: 12px; color: #666;">Supported: MP4, AVI, MOV, MKV</span>
                </label>
                <div class="file-info" id="videoFileName"></div>
            </div>

            <div class="controls">
                <button id="analyzeVideoBtn" disabled>Analyze Video</button>
                <button id="clearVideoBtn">Clear</button>
            </div>

            <div class="loading" id="videoLoading">
                <div class="spinner"></div>
                <p>Processing video... This may take a while</p>
            </div>

            <div id="videoResult" style="display: none;">
                <div class="message success" id="videoSuccess"></div>
                <button class="download-btn" id="downloadVideoBtn">Download Analyzed Video</button>
            </div>

            <div id="videoError"></div>
        </div>
    </div>

    <script>
        // ============ STATE MANAGEMENT ============
        const state = {
            image: {
                file: null,
                cameraActive: false,
                stream: null,
                animationId: null
            },
            video: {
                file: null
            }
        };

        // ============ UTILITY FUNCTIONS ============
        const $ = (id) => document.getElementById(id);
        const $$ = (selector) => document.querySelectorAll(selector);
        
        const show = (el) => el.style.display = el.tagName === 'DIV' ? 'block' : 'inline-block';
        const hide = (el) => el.style.display = 'none';
        const toggle = (el, condition) => condition ? show(el) : hide(el);

        const showMessage = (container, message, type = 'error') => {
            container.innerHTML = `<div class="message ${type}">${message}</div>`;
        };

        const clearMessage = (container) => container.innerHTML = '';

        // ============ TAB SWITCHING ============
        $$('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                $$('.tab-btn').forEach(b => b.classList.remove('active'));
                $$('.tab-content').forEach(c => c.classList.remove('active'));
                e.target.classList.add('active');
                $(e.target.dataset.tab).classList.add('active');
            });
        });

        // ============ DRAG & DROP HANDLER ============
        const setupDragDrop = (uploadSection, fileInput, handleFile) => {
            const handlers = {
                dragover: (e) => {
                    e.preventDefault();
                    uploadSection.classList.add('dragging');
                },
                dragleave: () => uploadSection.classList.remove('dragging'),
                drop: (e) => {
                    e.preventDefault();
                    uploadSection.classList.remove('dragging');
                    const files = e.dataTransfer.files;
                    if (files.length) {
                        fileInput.files = files;
                        handleFile();
                    }
                }
            };

            Object.entries(handlers).forEach(([event, handler]) => {
                uploadSection.addEventListener(event, handler);
            });
        };

        // ============ IMAGE HANDLING ============
        const els = {
            imageInput: $('imageInput'),
            imageFileName: $('imageFileName'),
            analyzeImageBtn: $('analyzeImageBtn'),
            clearImageBtn: $('clearImageBtn'),
            imageLoading: $('imageLoading'),
            imageResults: $('imageResults'),
            imageError: $('imageError'),
            camera: $('camera'),
            guideCanvas: $('guideCanvas'),
            toggleCameraBtn: $('toggleCameraBtn'),
            captureBtn: $('captureBtn'),
            retakeBtn: $('retakeBtn'),
            capturePreview: $('capturePreview'),
            capturedImage: $('capturedImage')
        };

        const setImageFile = (file, source = 'upload') => {
            state.image.file = file;
            els.imageFileName.textContent = source === 'camera' 
                ? '📸 Captured image from camera'
                : `Selected: ${file.name}`;
            els.analyzeImageBtn.disabled = false;
            clearMessage(els.imageError);
        };

        const clearImageState = () => {
            state.image.file = null;
            els.imageInput.value = '';
            els.imageFileName.textContent = '';
            els.analyzeImageBtn.disabled = true;
            hide(els.imageResults);
            hide(els.imageLoading);
            hide(els.capturePreview);
            hide(els.retakeBtn);
            show(els.toggleCameraBtn);
            els.toggleCameraBtn.textContent = '📸 Capture from Camera';
            clearMessage(els.imageError);
        };

        // ============ CAMERA FUNCTIONS ============
        const gctx = els.guideCanvas.getContext('2d');

        const stopCamera = () => {
            if (state.image.stream) {
                state.image.stream.getTracks().forEach(track => track.stop());
                state.image.stream = null;
            }
            if (state.image.animationId) {
                cancelAnimationFrame(state.image.animationId);
                state.image.animationId = null;
            }
            state.image.cameraActive = false;
            hide(els.camera);
            hide(els.guideCanvas);
            hide(els.captureBtn);
        };

        const startCamera = async () => {
            try {
                state.image.stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: { ideal: 'environment' } }
                });
                els.camera.srcObject = state.image.stream;
                show(els.camera);
                show(els.guideCanvas);
                show(els.captureBtn);
                state.image.cameraActive = true;
                els.toggleCameraBtn.textContent = '⏹ Stop Camera';
                drawGuides();
            } catch (e) {
                alert('Cannot access camera: ' + e.message);
            }
        };

        const getCenterBrightness = (frame) => {
            const { data, width, height } = frame;
            const bounds = {
                cx1: Math.floor(width * 0.4),
                cx2: Math.floor(width * 0.6),
                cy1: Math.floor(height * 0.4),
                cy2: Math.floor(height * 0.6)
            };

            let sumCenter = 0, sumOuter = 0, countCenter = 0, countOuter = 0;

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const i = (y * width + x) * 4;
                    const brightness = (data[i] + data[i + 1] + data[i + 2]) / 765; // Optimized: 3 * 255 = 765
                    const inCenter = (x >= bounds.cx1 && x <= bounds.cx2 && y >= bounds.cy1 && y <= bounds.cy2);
                    
                    if (inCenter) {
                        sumCenter += brightness;
                        countCenter++;
                    } else {
                        sumOuter += brightness;
                        countOuter++;
                    }
                }
            }
            
            return Math.abs((sumOuter / countOuter) - (sumCenter / countCenter));
        };

        const drawGuides = () => {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d', { willReadFrequently: true });

            const draw = () => {
                if (!state.image.cameraActive) return;

                // Update canvas size if needed
                if (els.guideCanvas.width !== els.camera.clientWidth || 
                    els.guideCanvas.height !== els.camera.clientHeight) {
                    els.guideCanvas.width = els.camera.clientWidth;
                    els.guideCanvas.height = els.camera.clientHeight;
                }

                const w = els.guideCanvas.width;
                const h = els.guideCanvas.height;
                const centerBox = {
                    w: w * 0.4,
                    h: h * 0.4,
                    x: w * 0.3,
                    y: h * 0.3
                };

                gctx.clearRect(0, 0, w, h);

                // Rule of thirds grid
                gctx.strokeStyle = "rgba(255,255,255,0.3)";
                gctx.lineWidth = 1;
                for (let i = 1; i < 3; i++) {
                    const x = (w / 3) * i;
                    const y = (h / 3) * i;
                    gctx.beginPath();
                    gctx.moveTo(x, 0);
                    gctx.lineTo(x, h);
                    gctx.stroke();
                    gctx.beginPath();
                    gctx.moveTo(0, y);
                    gctx.lineTo(w, y);
                    gctx.stroke();
                }

                // Brightness analysis
                if (els.camera.readyState === els.camera.HAVE_ENOUGH_DATA) {
                    tempCanvas.width = 64;
                    tempCanvas.height = 48;
                    tempCtx.drawImage(els.camera, 0, 0, 64, 48);

                    const frame = tempCtx.getImageData(0, 0, 64, 48);
                    const isCentered = getCenterBrightness(frame) > 0.25;

                    // Center box
                    gctx.strokeStyle = isCentered ? "rgba(0,255,0,0.9)" : "rgba(230,57,70,0.9)";
                    gctx.lineWidth = 3;
                    gctx.strokeRect(centerBox.x, centerBox.y, centerBox.w, centerBox.h);

                    // Hint text
                    gctx.font = "18px Segoe UI";
                    gctx.fillStyle = "rgba(255,255,255,0.8)";
                    gctx.fillText(isCentered ? "✅ Ready to capture" : "Align object to center box", 20, 30);
                }

                state.image.animationId = requestAnimationFrame(draw);
            };
            
            draw();
        };

        // ============ IMAGE ANALYSIS ============
        const analyzeImage = async () => {
            if (!state.image.file) return;

            show(els.imageLoading);
            hide(els.imageResults);
            clearMessage(els.imageError);

            const formData = new FormData();
            formData.append('file', state.image.file);

            try {
                const [predRes, visRes] = await Promise.all([
                    fetch('/predict-image', { method: 'POST', body: formData }),
                    fetch('/visualize-image', { method: 'POST', body: formData })
                ]);

                const predData = await predRes.json();
                const visBlob = await visRes.blob();

                // Display images
                $('originalImage').src = URL.createObjectURL(state.image.file);
                $('visualizedImage').src = URL.createObjectURL(visBlob);

                // Display stats
                $('imageStats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${predData.num_detections}</div>
                        <div class="stat-label">Objects Detected</div>
                    </div>
                `;

                // Display info
                const info = $('imageInfo');
                info.innerHTML = predData.detections.length > 0
                    ? '<h4>Detection Results:</h4>' + predData.detections
                        .map((d, i) => `<div>#${i+1} | ID:${d.label_id} | Score:${d.score.toFixed(4)} | Box:[${Math.round(d.x_min)}, ${Math.round(d.y_min)}, ${Math.round(d.x_max)}, ${Math.round(d.y_max)}]</div>`)
                        .join('')
                    : '<h4>No objects detected</h4>';

                hide(els.imageLoading);
                els.imageResults.style.display = 'grid';
            } catch (e) {
                hide(els.imageLoading);
                showMessage(els.imageError, `Error: ${e.message}`);
                console.error(e);
            }
        };

        // ============ VIDEO ANALYSIS ============
        const videoEls = {
            input: $('videoInput'),
            fileName: $('videoFileName'),
            analyzeBtn: $('analyzeVideoBtn'),
            clearBtn: $('clearVideoBtn'),
            loading: $('videoLoading'),
            result: $('videoResult'),
            error: $('videoError'),
            success: $('videoSuccess'),
            downloadBtn: $('downloadVideoBtn')
        };

        const setVideoFile = (file) => {
            state.video.file = file;
            videoEls.fileName.textContent = `Selected: ${file.name} (${(file.size / 1048576).toFixed(2)} MB)`;
            videoEls.analyzeBtn.disabled = false;
            clearMessage(videoEls.error);
        };

        const clearVideoState = () => {
            state.video.file = null;
            videoEls.input.value = '';
            videoEls.fileName.textContent = '';
            videoEls.analyzeBtn.disabled = true;
            hide(videoEls.result);
            hide(videoEls.loading);
            clearMessage(videoEls.error);
        };

        const analyzeVideo = async () => {
            if (!state.video.file) return;

            show(videoEls.loading);
            hide(videoEls.result);
            clearMessage(videoEls.error);

            const formData = new FormData();
            formData.append('file', state.video.file);

            try {
                const res = await fetch('/analyze-video', { method: 'POST', body: formData });
                
                if (!res.ok) {
                    const errData = await res.json();
                    throw new Error(errData.error || 'Video analysis failed');
                }

                const blob = await res.blob();
                const url = URL.createObjectURL(blob);

                hide(videoEls.loading);
                videoEls.success.textContent = '✅ Video analyzed successfully!';
                videoEls.downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'analyzed_' + state.video.file.name;
                    a.click();
                };
                show(videoEls.result);
            } catch (e) {
                hide(videoEls.loading);
                showMessage(videoEls.error, `Error: ${e.message}`);
                console.error(e);
            }
        };

        // ============ EVENT LISTENERS ============
        
        // Tabs are already set up above

        // Image upload
        setupDragDrop(
            document.querySelector('[data-upload="image"]'),
            els.imageInput,
            () => {
                const file = els.imageInput.files[0];
                if (file) setImageFile(file, 'upload');
            }
        );
        els.imageInput.addEventListener('change', () => {
            const file = els.imageInput.files[0];
            if (file) setImageFile(file, 'upload');
        });

        // Camera controls
        els.toggleCameraBtn.addEventListener('click', () => {
            state.image.cameraActive ? stopCamera() : startCamera();
        });

        els.captureBtn.addEventListener('click', () => {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = els.camera.videoWidth;
            tempCanvas.height = els.camera.videoHeight;
            const ctx = tempCanvas.getContext('2d');
            ctx.drawImage(els.camera, 0, 0, tempCanvas.width, tempCanvas.height);

            tempCanvas.toBlob((blob) => {
                const file = new File([blob], "captured.jpg", { type: "image/jpeg" });
                setImageFile(file, 'camera');
                
                els.capturedImage.src = URL.createObjectURL(blob);
                show(els.capturePreview);
                hide(els.camera);
                hide(els.guideCanvas);
                hide(els.captureBtn);
                show(els.retakeBtn);
                hide(els.toggleCameraBtn);
                
                stopCamera();
            }, "image/jpeg", 0.9);
        });

        els.retakeBtn.addEventListener('click', () => {
            hide(els.capturePreview);
            hide(els.retakeBtn);
            show(els.toggleCameraBtn);
            els.imageFileName.textContent = '';
            state.image.file = null;
            els.analyzeImageBtn.disabled = true;
            startCamera();
        });

        // Image actions
        els.analyzeImageBtn.addEventListener('click', analyzeImage);
        els.clearImageBtn.addEventListener('click', clearImageState);

        // Video upload
        setupDragDrop(
            document.querySelector('[data-upload="video"]'),
            videoEls.input,
            () => {
                const file = videoEls.input.files[0];
                if (file) setVideoFile(file);
            }
        );
        videoEls.input.addEventListener('change', () => {
            const file = videoEls.input.files[0];
            if (file) setVideoFile(file);
        });

        // Video actions
        videoEls.analyzeBtn.addEventListener('click', analyzeVideo);
        videoEls.clearBtn.addEventListener('click', clearVideoState);
    </script>
</body>
</html>